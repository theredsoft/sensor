#!/bin/bash

# –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è VL53L1X
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º

echo "======================================"
echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è VL53L1X"
echo "======================================"
echo ""

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞
error_msg() { echo -e "${RED}‚úó $1${NC}"; }
success_msg() { echo -e "${GREEN}‚úì $1${NC}"; }
warning_msg() { echo -e "${YELLOW}‚ö† $1${NC}"; }
info_msg() { echo -e "${BLUE}‚Ñπ $1${NC}"; }

echo "1Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# –í–µ—Ä—Å–∏—è –û–°
OS_VERSION=$(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)
echo "–û–°: $OS_VERSION"

# –ú–æ–¥–µ–ª—å Raspberry Pi
if [ -f /proc/device-tree/model ]; then
    MODEL=$(cat /proc/device-tree/model)
    echo "–ú–æ–¥–µ–ª—å: $MODEL"
fi

# –í–µ—Ä—Å–∏—è Python
PYTHON_VERSION=$(python3 --version)
echo "Python: $PYTHON_VERSION"

echo ""
echo "2Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ I2C"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è I2C
if [ -f /boot/firmware/config.txt ]; then
    CONFIG_FILE="/boot/firmware/config.txt"
elif [ -f /boot/config.txt ]; then
    CONFIG_FILE="/boot/config.txt"
else
    error_msg "config.txt –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    CONFIG_FILE=""
fi

if [ -n "$CONFIG_FILE" ]; then
    if grep -q "^dtparam=i2c_arm=on" "$CONFIG_FILE"; then
        success_msg "I2C –≤–∫–ª—é—á–µ–Ω –≤ $CONFIG_FILE"
    else
        error_msg "I2C –ù–ï –≤–∫–ª—é—á–µ–Ω –≤ $CONFIG_FILE"
        echo "   –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –¥–æ–±–∞–≤—å—Ç–µ 'dtparam=i2c_arm=on' –≤ $CONFIG_FILE"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ I2C
    if grep -q "dtparam=i2c_baudrate=" "$CONFIG_FILE"; then
        SPEED=$(grep "dtparam=i2c_baudrate=" "$CONFIG_FILE" | cut -d'=' -f2)
        info_msg "–°–∫–æ—Ä–æ—Å—Ç—å I2C: $SPEED –ì—Ü"
        if [ "$SPEED" -gt 400000 ]; then
            warning_msg "–°–∫–æ—Ä–æ—Å—Ç—å —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è –¥–ª—è VL53L1X"
            echo "   –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ 100000 –∏–ª–∏ 400000"
        fi
    else
        info_msg "–°–∫–æ—Ä–æ—Å—Ç—å I2C: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (100000 –ì—Ü)"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥—É–ª–µ–π
echo ""
echo "–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ I2C:"
if lsmod | grep -q i2c_bcm; then
    success_msg "i2c_bcm –∑–∞–≥—Ä—É–∂–µ–Ω"
else
    warning_msg "i2c_bcm –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω"
    echo "   –ó–∞–≥—Ä—É–∑–∫–∞: sudo modprobe i2c-bcm2835"
    sudo modprobe i2c-bcm2835 2>/dev/null
fi

if lsmod | grep -q i2c_dev; then
    success_msg "i2c_dev –∑–∞–≥—Ä—É–∂–µ–Ω"
else
    warning_msg "i2c_dev –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω"
    echo "   –ó–∞–≥—Ä—É–∑–∫–∞: sudo modprobe i2c-dev"
    sudo modprobe i2c-dev 2>/dev/null
fi

echo ""
echo "3Ô∏è‚É£  –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∏–Ω—ã I2C"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Å–∫–æ—Ä–æ—Å—Ç–µ–π
echo "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏..."
DEVICES=$(sudo i2cdetect -y 1 2>/dev/null | grep -E "([0-9a-f]{2})" | grep -v "^   " | grep -v "^$")

if echo "$DEVICES" | grep -q "29"; then
    success_msg "VL53L1X –Ω–∞–π–¥–µ–Ω –Ω–∞ –∞–¥—Ä–µ—Å–µ 0x29!"
else
    error_msg "VL53L1X –ù–ï –Ω–∞–π–¥–µ–Ω –Ω–∞ –∞–¥—Ä–µ—Å–µ 0x29"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –∞–¥—Ä–µ—Å–∞
    echo ""
    echo "–ü–æ–∏—Å–∫ –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤..."
    sudo i2cdetect -y 1

    # –°—á–∏—Ç–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    DEVICE_COUNT=$(sudo i2cdetect -y 1 2>/dev/null | grep -o "[0-9a-f][0-9a-f]" | grep -v "^ " | wc -l)

    if [ "$DEVICE_COUNT" -eq 0 ]; then
        error_msg "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ I2C –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã!"
    else
        warning_msg "–ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: $DEVICE_COUNT (–Ω–æ –Ω–µ VL53L1X)"
    fi
fi

echo ""
echo "4Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∏—Ç–∞–Ω–∏—è –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

echo ""
echo "–£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo ""
echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
echo "‚îÇ  ${YELLOW}VL53L1X${NC}   ‚îÇ    ${GREEN}Raspberry Pi GPIO${NC}     ‚îÇ"
echo "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§"
echo "‚îÇ    VIN     ‚îÇ  ${RED}3.3V${NC} (Pin 1) ${YELLOW}–ù–ï 5V!${NC}    ‚îÇ"
echo "‚îÇ    GND     ‚îÇ  GND (Pin 6 –∏–ª–∏ 9)      ‚îÇ"
echo "‚îÇ    SCL     ‚îÇ  GPIO3/SCL (Pin 5)      ‚îÇ"
echo "‚îÇ    SDA     ‚îÇ  GPIO2/SDA (Pin 3)      ‚îÇ"
echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"

echo ""
warning_msg "–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 3.3V, –ù–ï 5V!"
echo ""

echo "5Ô∏è‚É£  –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

if [ "$DEVICE_COUNT" -eq 0 ]; then
    echo ""
    echo "üî¥ –î–∞—Ç—á–∏–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo ""
    echo "1. ${YELLOW}–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∏—Ç–∞–Ω–∏–µ–º:${NC}"
    echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 3.3V)"
    echo "   ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ GND –ø–æ–¥–∫–ª—é—á–µ–Ω"
    echo "   ‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ 3.3V"
    echo ""
    echo "2. ${YELLOW}–ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–≤–æ–¥–∞–º–∏:${NC}"
    echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–æ–¥–æ–≤"
    echo "   ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤"
    echo "   ‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–æ–≤–æ–¥–∞"
    echo ""
    echo "3. ${YELLOW}–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ pull-up —Ä–µ–∑–∏—Å—Ç–æ—Ä–æ–≤:${NC}"
    echo "   ‚Ä¢ –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–¥—É–ª–∏ VL53L1X –Ω–µ –∏–º–µ—é—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ä–µ–∑–∏—Å—Ç–æ—Ä–æ–≤"
    echo "   ‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ —Ä–µ–∑–∏—Å—Ç–æ—Ä—ã 4.7kŒ© –æ—Ç SDA –∏ SCL –∫ 3.3V"
    echo ""
    echo "4. ${YELLOW}–ù–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å –¥–∞—Ç—á–∏–∫–∞:${NC}"
    echo "   ‚Ä¢ –î–∞—Ç—á–∏–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω"
    echo "   ‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –¥–∞—Ç—á–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å"
fi

echo ""
echo "6Ô∏è‚É£  –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ GPIO
echo ""
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è GPIO –ø–∏–Ω–æ–≤..."
if command -v gpio &> /dev/null; then
    echo "GPIO 2 (SDA): $(gpio read 2 2>/dev/null || echo '–Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω')"
    echo "GPIO 3 (SCL): $(gpio read 3 2>/dev/null || echo '–Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω')"
else
    info_msg "–£—Ç–∏–ª–∏—Ç–∞ gpio –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
fi

# –ü–æ–ø—ã—Ç–∫–∞ —Å–±—Ä–æ—Å–∞ —à–∏–Ω—ã
echo ""
read -p "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–±—Ä–æ—Å–∏—Ç—å —à–∏–Ω—É I2C? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "–°–±—Ä–æ—Å —à–∏–Ω—ã I2C..."
    sudo rmmod i2c_bcm2835 2>/dev/null
    sudo rmmod i2c_dev 2>/dev/null
    sleep 1
    sudo modprobe i2c_dev
    sudo modprobe i2c_bcm2835
    sleep 1

    echo "–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ..."
    sudo i2cdetect -y 1

    if sudo i2cdetect -y 1 2>/dev/null | grep -q "29"; then
        success_msg "VL53L1X –æ–±–Ω–∞—Ä—É–∂–µ–Ω –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞!"
    else
        error_msg "VL53L1X –≤—Å–µ –µ—â–µ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω"
    fi
fi

echo ""
echo "======================================"
echo "üìä –ò—Ç–æ–≥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"
echo "======================================"

# –ü–æ–¥—Å—á–µ—Ç –ø—Ä–æ–±–ª–µ–º
PROBLEMS=0

if ! sudo i2cdetect -y 1 2>/dev/null | grep -q "29"; then
    error_msg "–î–∞—Ç—á–∏–∫ VL53L1X –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω"
    PROBLEMS=$((PROBLEMS + 1))
fi

if [ "$PROBLEMS" -eq 0 ]; then
    echo ""
    success_msg "–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ —Å VL53L1X!"
    echo ""
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∞—Ç—á–∏–∫:"
    echo "  sudo venv/bin/python vl53l1x_minimal.py"
else
    echo ""
    error_msg "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã. –°–º. —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—ã—à–µ."
    echo ""
    echo "–ü–æ—Å–ª–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–Ω–æ–≤–∞:"
    echo "  bash diagnose.sh"
fi

echo ""